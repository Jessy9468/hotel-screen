<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>√âcran tarifs & infos - Ibis Vitr√©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <link rel="icon" 
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' 
          viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' 
          fill='%23CC0033'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' 
          text-anchor='middle' font-size='34' fill='white' 
          font-family='Arial, sans-serif'%3Ei%3C/text%3E%3C/svg%3E">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    width: 100%;
    height: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #000;
    color: #fff;
}
body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}

/* --- LAYOUT --- */
.layout {
    display: grid;
    grid-template-columns: 1.25fr 1fr;
    gap: 16px;
    padding: 16px;
    width: 100vw;
    height: 100vh;
    transform-origin: top left;
}

.panel {
    background: #111;
    border-radius: 16px;
    padding: 14px 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
}

.panel-widgets {
    overflow: hidden;
}

/* --- TARIFS --- */
.panel-header-top {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}
.panel-logo {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    max-height: 60px;
    object-fit: contain;
}
.panel-title-block {
    text-align: center;
    line-height: 1.25;
}
.panel-title-line1 {
    font-size: 24px;
    font-weight: 700;
}
.panel-subtitle {
    font-size: 13px;
    opacity: .85;
}

.rate-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    opacity: .9;
}
.rate-date { font-weight: 600; }

.rates-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 17px;
}
.rates-table thead tr { background: #CC0033; }
.rates-table thead th {
    padding: 8px 10px;
    font-size: 13px;
    text-transform: uppercase;
}
.rates-table tbody tr:nth-child(odd) { background: #E5093B; }
.rates-table tbody tr:nth-child(even){ background: #F2405F; }
.rates-table td { padding: 10px; }
.rates-label { font-weight: 600; }

/* --- DETAILS --- */
.details-grid {
    display: grid;
    grid-template-columns: 1fr auto;
    row-gap: 4px;
    column-gap: 20px;
    margin-top: 18px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.2);
}

/* --- FOOTER PANEL --- */
.hotel-name {
    text-align: center;
    margin-top: 16px;
    font-size: 15px;
    font-weight: 700;
}
.footer-text {
    text-align: center;
    font-size: 11px;
    opacity: .85;
}
.panel-bottom { margin-top: auto; }

/* --- WIDGETS --- */
.widgets {
    display: flex;
    flex-direction: column;
    gap: 14px;
    min-height: 0;
}
.widget {
    background: #151515;
    border-radius: 14px;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.widget-sticky { position: sticky; top: 0; }

/* --- INFOS IMPORTANTES --- */
.info-item { font-size: 13px; margin-bottom: 4px; }

/* --- METEO (NOUVELLE VERSION) --- */
#widget-meteo { padding: 10px 14px; }

.weather-main {
    display: grid;
    grid-template-columns: 1fr 120px;
    gap: 12px;
    align-items: center;
}

/* METEO DU JOUR */
.weather-today { text-align: center; }
.weather-temp {
    font-size: 32px;
    font-weight: 700;
}
.weather-desc {
    font-size: 14px;
    opacity: .9;
    margin-bottom: 4px;
}
.weather-extra {
    font-size: 12px;
    opacity: .85;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

/* METEO DEMAIN */
.weather-tomorrow {
    background: rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 6px 8px;
    text-align: center;
    font-size: 12px;
}
.weather-tomorrow-icon {
    display: block;
    font-size: 20px;
}
.weather-tomorrow-temp {
    font-weight: 600;
    margin-top: 3px;
}

/* --- MENU DU JOUR --- */
.menu-title {
    font-size: 16px;
    font-weight: 600;
}
.menu-items { font-size: 13px; line-height: 1.4; }

/* --- PHOTOS CARROUSEL --- */
.photo-wrapper {
    position: relative;
    height: 260px;
    border-radius: 12px;
    overflow: hidden;
}
.photo-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.photo-caption {
    position: absolute;
    left: 0; right: 0; bottom: 0;
    padding: 6px 10px;
    font-size: 12px;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
}
</style>
</head>
<body>

<div class="layout" id="layout-root">

    <!-- PANEL TARIFS -->
    <div class="panel">
        <div class="panel-header-top">
            <img id="logo-img" class="panel-logo" src="" alt="Logo h√¥tel">
            <div class="panel-title-block">
                <div class="panel-title-line1">Prix des chambres / Room rates</div>
                <div class="panel-subtitle">Net prices in ‚Ç¨ VAT / par jour ¬∑ per day</div>
            </div>
        </div>
        <div class="rate-header">
            <div>Room rates</div>
            <div class="rate-date" id="rate-date"></div>
        </div>

        <table class="rates-table">
            <thead>
                <tr>
                    <th>Type de prestation</th>
                    <th style="text-align:right;">Prix / Rates</th>
                </tr>
            </thead>
            <tbody id="rates-body"></tbody>
        </table>

        <div class="details-grid" id="details-grid"></div>

        <div class="panel-bottom">
            <div class="hotel-name" id="hotel-name">
                Bienvenue √† l'h√¥tel ibis Vitr√© Centre
            </div>
            <div class="footer-text" id="footer-text"></div>
        </div>
    </div>

    <!-- ‚ñº‚ñº COLONNE DROITE : WIDGETS ‚ñº‚ñº -->
    <div class="panel panel-widgets">
        <div class="widgets">

            <!-- INFORMATIONS IMPORTANTES -->
            <section class="widget widget-sticky" id="widget-infos">
                <div class="widget-header">
                    <div class="widget-title">Informations importantes</div>
                </div>
                <div id="infos-list"></div>
            </section>

            <!-- M√âT√âO -->
            <section class="widget" id="widget-meteo">
                <div class="widget-header">
                    <div>
                        <div class="widget-title">M√©t√©o</div>
                        <div class="widget-sub" id="weather-location">Vitr√©</div>
                    </div>
                    <div class="widget-sub" id="weather-updated">‚Äî</div>
                </div>

                <div class="weather-main">

                    <!-- M√âT√âO DU JOUR -->
                    <div class="weather-today">
                        <div class="weather-temp" id="weather-temp">--¬∞C</div>
                        <div class="weather-desc" id="weather-desc">Chargement‚Ä¶</div>

                        <div class="weather-extra">
                            <span id="weather-highlow"></span>
                            <span id="weather-humidity"></span>
                            <span id="weather-wind"></span>
                        </div>
                    </div>

                    <!-- M√âT√âO DE DEMAIN -->
                    <div class="weather-tomorrow">
                        <div class="weather-tomorrow-icon" id="tomorrow-icon">‚òÄÔ∏è</div>
                        <div id="tomorrow-desc">Demain</div>
                        <div class="weather-tomorrow-temp" id="tomorrow-temp">--¬∞ / --¬∞</div>
                    </div>

                </div>
            </section>

            <!-- MENU DU JOUR -->
            <section class="widget" id="widget-menu">
                <div class="widget-header">
                    <div class="widget-title" id="menu-widget-title">Menu du jour</div>
                    <div class="widget-sub" id="menu-date"></div>
                </div>

                <div class="menu-title" id="menu-title">Chargement‚Ä¶</div>
                <div class="menu-items" id="menu-items"></div>
            </section>

            <!-- PHOTOS -->
            <section class="widget" id="widget-photos">
                <div class="widget-header">
                    <div class="widget-title">D√©couvrir l'h√¥tel</div>
                </div>

                <div class="photo-wrapper">
                    <img id="photo-img" src="" alt="Photo h√¥tel" />
                    <div class="photo-caption" id="photo-caption"></div>
                </div>
            </section>

        </div>
    </div>

</div>
    <script>
/*********************
 *   CONFIG G√âN√âRALE
 *********************/
const SHEET_PUB_ID = "2PACX-1vThauH2vp6V4TkYj6VbVV6BT3fz_ggJIlgVHOzo6EGXg3fJtoaGxdLjUW8_1cIcpw";

const GID_TARIFS     = "618820453";
const GID_DETAILS    = "126337975";
const GID_MENU       = "695467279";
const GID_INFOS      = "1342307900";
const GID_PHOTOS     = "407579197";
const GID_MENTIONS   = "1712757088";
const GID_PARAMETRES = "1182660406";

const LAT = 48.123;
const LON = -1.208;

const DEFAULT_SETTINGS = {
    refreshMainMinutes: 10,
    refreshWeatherMinutes: 20,
    photoIntervalSeconds: 8,
    weatherLocationLabel: "Vitr√©",
    screenWidthPx: null,
    screenHeightPx: null,
    uiScale: 1,
    menuWidgetTitle: "Menu du jour"
};

let SETTINGS = { ...DEFAULT_SETTINGS };

let mainIntervalId = null;
let weatherIntervalId = null;
let photoRotationId = null;


/*********************
 *   UTILS CSV
 *********************/
function fetchCsv(gid) {
    const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_PUB_ID}/pub?gid=${gid}&single=true&output=csv`;

    return fetch(url)
        .then(r => r.ok ? r.text() : "")
        .then(parseCsv)
        .catch(() => []);
}

function parseCsv(text) {
    if (!text) return [];
    const lines = text.trim().split(/\r?\n/);
    const header = splitCsvLine(lines[0]);

    return lines.slice(1).map(l => {
        const cols = splitCsvLine(l);
        const obj = {};
        header.forEach((h, i) => obj[h] = (cols[i] || "").trim());
        return obj;
    });
}

function splitCsvLine(line) {
    let out = [], cur = "", q = false;
    for (let c of line) {
        if (c === '"') q = !q;
        else if (c === "," && !q) { out.push(cur); cur = ""; }
        else cur += c;
    }
    out.push(cur);
    return out;
}

function escapeHtml(str) {
    return str.replace(/[&<>]/g, c => 
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c] )
    );
}

function normalizeImageUrl(u) {
    if (!u) return "";
    u = u.trim();

    // D√©j√† une URL directe
    if (!u.includes("drive.google.com")) return u;

    // Format Drive standard ?export=view&id=xxx
    if (u.includes("uc?export=view&id=")) return u;

    // /file/d/ID/... ?
    let match = u.match(/\/file\/d\/([^\/]+)/);
    if (match && match[1]) {
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }

    // ?id=ID
    match = u.match(/[?&]id=([^&]+)/);
    if (match && match[1]) {
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }

    return u;
}


/*********************
 *   PARAM√àTRES
 *********************/
async function loadSettings() {
    const rows = await fetchCsv(GID_PARAMETRES);

    rows.forEach(r => {
        const key = (r["cle"] || "").toLowerCase();
        const val = (r["valeur"] || "").trim();

        switch (key) {
            case "refresh_main_minutes":
                if (+val > 0) SETTINGS.refreshMainMinutes = +val;
                break;
            case "refresh_weather_minutes":
                if (+val > 0) SETTINGS.refreshWeatherMinutes = +val;
                break;
            case "photo_interval_seconds":
                if (+val > 0) SETTINGS.photoIntervalSeconds = +val;
                break;
            case "weather_location_label":
                if (val) SETTINGS.weatherLocationLabel = val;
                break;
            case "screen_width_px":
                if (+val > 0) SETTINGS.screenWidthPx = +val;
                break;
            case "screen_height_px":
                if (+val > 0) SETTINGS.screenHeightPx = +val;
                break;
            case "ui_scale":
                if (+val > 0) SETTINGS.uiScale = parseFloat(val.replace(",", "."));
                break;
            case "menu_widget_title":
                if (val) SETTINGS.menuWidgetTitle = val;
                break;
        }
    });

    document.getElementById("weather-location").textContent = SETTINGS.weatherLocationLabel;
    document.getElementById("menu-widget-title").textContent = SETTINGS.menuWidgetTitle;

    applyScaling();
}

function applyScaling() {
    const root = document.getElementById("layout-root");
    if (!root) return;

    let scale = 1;

    if (SETTINGS.screenWidthPx && SETTINGS.screenHeightPx) {
        const sx = window.innerWidth / SETTINGS.screenWidthPx;
        const sy = window.innerHeight / SETTINGS.screenHeightPx;
        scale = Math.min(sx, sy);
    }

    scale *= SETTINGS.uiScale;
    root.style.transform = `scale(${scale})`;
}

window.addEventListener("resize", applyScaling);

function setupIntervals() {
    clearInterval(mainIntervalId);
    clearInterval(weatherIntervalId);

    mainIntervalId = setInterval(() => {
        loadTarifs();
        loadDetails();
        loadMenu();
        loadInfos();
        loadPhotos();
        loadMentions();
    }, SETTINGS.refreshMainMinutes * 60 * 1000);

    weatherIntervalId = setInterval(loadWeather, SETTINGS.refreshWeatherMinutes * 60 * 1000);
}


/*********************
 *   TARIFS
 *********************/
function loadTarifs() {
    fetchCsv(GID_TARIFS).then(rows => {
        const tbody = document.getElementById("rates-body");
        tbody.innerHTML = "";

        rows.forEach(r => {
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="rates-label">${escapeHtml(r.type || "")}</div>
                        <div class="rates-sub">${escapeHtml(r.sous_titre || "")}</div>
                    </td>
                    <td class="rates-price">${escapeHtml(r.prix || "")}</td>
                </tr>
            `;
        });

        const now = new Date();
        document.getElementById("rate-date").textContent =
            now.toLocaleDateString("fr-FR", {
                weekday: "long",
                day: "numeric",
                month: "long",
                year: "numeric"
            });
    });
}

function loadDetails() {
    fetchCsv(GID_DETAILS).then(rows => {
        const grid = document.getElementById("details-grid");
        grid.innerHTML = "";

        rows.forEach(r => {
            if (!r.libelle && !r.prix) return;
            grid.innerHTML += `
                <div>${escapeHtml(r.libelle || "")}</div>
                <div style="text-align:right;font-weight:600;">${escapeHtml(r.prix || "")}</div>
            `;
        });
    });
}


/*********************
 *   METEO
 *********************/
function iconFor(code) {
    if (code === 0) return "‚òÄÔ∏è";
    if ([1,2,3].includes(code)) return "üå§Ô∏è";
    if ([45,48].includes(code)) return "üå´Ô∏è";
    if ([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
    if ([61,63,65].includes(code)) return "üåßÔ∏è";
    if ([71,73,75,77].includes(code)) return "‚ùÑÔ∏è";
    if ([80,81,82].includes(code)) return "üåßÔ∏è";
    if ([95,96,99].includes(code)) return "‚õàÔ∏è";
    return "‚òÅÔ∏è";
}
function labelFor(code) {
    if (code === 0) return "Ciel d√©gag√©";
    if ([1,2,3].includes(code)) return "Partiellement nuageux";
    if ([45,48].includes(code)) return "Brouillard";
    if ([51,53,55,56,57].includes(code)) return "Bruine";
    if ([61,63,65].includes(code)) return "Pluie";
    if ([71,73,75,77].includes(code)) return "Neige";
    if ([80,81,82].includes(code)) return "Averses";
    if ([95,96,99].includes(code)) return "Orages";
    return "Conditions diverses";
}

function loadWeather() {
    const url = `https://api.open-meteo.com/v1/forecast
        ?latitude=${LAT}&longitude=${LON}
        &current=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m
        &daily=temperature_2m_max,temperature_2m_min,weather_code
        &timezone=auto`.replace(/\s+/g, "");

    fetch(url)
        .then(r => r.json())
        .then(data => {
            const now = data.current;
            const daily = data.daily;

            // METEO DU JOUR
            document.getElementById("weather-temp").textContent =
                Math.round(now.temperature_2m) + "¬∞C";
            document.getElementById("weather-desc").innerHTML =
                iconFor(now.weather_code) + " " + labelFor(now.weather_code);

            document.getElementById("weather-highlow").textContent =
                `Max ${Math.round(daily.temperature_2m_max[0])}¬∞ / Min ${
                    Math.round(daily.temperature_2m_min[0])
                }¬∞`;

            document.getElementById("weather-humidity").textContent =
                `Humidit√© ${now.relative_humidity_2m}%`;

            document.getElementById("weather-wind").textContent =
                `Vent ${Math.round(now.wind_speed_10m)} km/h`;

            document.getElementById("weather-updated").textContent =
                "Maj " + new Date(now.time).toLocaleTimeString("fr-FR", {
                    hour: "2-digit",
                    minute: "2-digit"
                });

            // METEO DEMAIN
            const codeTomorrow = daily.weather_code[1];
            const maxTomorrow = Math.round(daily.temperature_2m_max[1]);
            const minTomorrow = Math.round(daily.temperature_2m_min[1]);

            document.getElementById("tomorrow-icon").textContent = iconFor(codeTomorrow);
            document.getElementById("tomorrow-desc").textContent = labelFor(codeTomorrow);
            document.getElementById("tomorrow-temp").textContent =
                `${maxTomorrow}¬∞ / ${minTomorrow}¬∞`;
        });
}


/*********************
 *   MENU DU JOUR
 *********************/
function loadMenu() {
    fetchCsv(GID_MENU).then(rows => {
        const widget = document.getElementById("widget-menu");
        if (!rows.length) {
            widget.style.display = "none";
            return;
        }

        const first = rows[0];
        const subtitle = first.sous_titre || "";
        document.getElementById("menu-title").textContent = subtitle;

        let lines = rows
            .map(r => {
                const t = r.titre || r.menu || "";
                const p = r.prix || "";
                const i = r.items || r.item || "";
                if (t && p) return `${t} ‚Äî ${p}`;
                if (t && i) return `${t} ‚Äî ${i}`;
                return t || i;
            })
            .filter(x => x);

        lines = lines.slice(0, 4);

        document.getElementById("menu-items").innerHTML =
            lines.map(l => "‚Ä¢ " + escapeHtml(l)).join("<br>");

        const now = new Date();
        document.getElementById("menu-date").textContent =
            now.toLocaleDateString("fr-FR", {
                weekday: "long",
                day: "numeric",
                month: "long"
            });
    });
}


/*********************
 *   INFOS IMPORTANTES
 *********************/
function loadInfos() {
    fetchCsv(GID_INFOS).then(rows => {
        const container = document.getElementById("infos-list");
        container.innerHTML = "";

        rows.forEach(r => {
            if (!r.texte) return;
            container.innerHTML += `<div class="info-item">‚Ä¢ ${escapeHtml(r.texte)}</div>`;
        });
    });
}


/*********************
 *   MENTIONS
 *********************/
function loadMentions() {
    fetchCsv(GID_MENTIONS).then(rows => {
        if (!rows.length) return;
        document.getElementById("footer-text").textContent =
            rows[0].mention || "";
    });
}


/*********************
 *   PHOTOS + LOGO
 *********************/
let photos = [];
let currentPhoto = 0;

function loadPhotos() {
    fetchCsv(GID_PHOTOS).then(rows => {
        const valid = rows.filter(r => r.url);

        let logoRow = valid.find(r => (r.legende || "").toLowerCase().includes("logo"));
        if (!logoRow) logoRow = valid[0];

        // LOGO
        document.getElementById("logo-img").src = normalizeImageUrl(logoRow.url);

        // PHOTOS (hors logo)
        photos = valid.filter(r => r !== logoRow);

        if (!photos.length) {
            document.getElementById("widget-photos").style.display = "none";
            return;
        }

        currentPhoto = 0;
        showPhoto();

        clearInterval(photoRotationId);
        photoRotationId = setInterval(() => {
            currentPhoto = (currentPhoto + 1) % photos.length;
            showPhoto();
        }, SETTINGS.photoIntervalSeconds * 1000);
    });
}

function showPhoto() {
    const p = photos[currentPhoto];
    const url = normalizeImageUrl(p.url);

    const img = document.getElementById("photo-img");
    img.src = url;
    img.alt = p.legende || "";
    document.getElementById("photo-caption").textContent = p.legende || "";
}


/*********************
 *   INIT
 *********************/
async function init() {
    await loadSettings();

    loadTarifs();
    loadDetails();
    loadMenu();
    loadInfos();
    loadMentions();
    loadPhotos();
    loadWeather();

    setupIntervals();
}

init();
</script>

</body>
</html>

    
